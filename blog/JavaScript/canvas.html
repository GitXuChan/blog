<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信小程序canvas | 程序员徐婵</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="./assets/js/autopush-baidu.js"></script>
    <script src="./assets/js/autopush-360.js"></script>
    <meta name="description" content="徐婵个人博客">
    
    <link rel="preload" href="./assets/css/0.styles.21cd1aa6.css" as="style"><link rel="preload" href="./assets/js/app.6fdaac57.js" as="script"><link rel="preload" href="./assets/js/53.a6c4e3ad.js" as="script"><link rel="preload" href="./assets/js/2.e424c73a.js" as="script"><link rel="preload" href="./assets/js/57.61cb8b5f.js" as="script"><link rel="prefetch" href="./assets/js/10.224151a5.js"><link rel="prefetch" href="./assets/js/100.9a233a5b.js"><link rel="prefetch" href="./assets/js/101.3b0a432f.js"><link rel="prefetch" href="./assets/js/102.aa29fd8b.js"><link rel="prefetch" href="./assets/js/103.2f1e4409.js"><link rel="prefetch" href="./assets/js/104.0e290055.js"><link rel="prefetch" href="./assets/js/105.2543de76.js"><link rel="prefetch" href="./assets/js/106.aab4bcc7.js"><link rel="prefetch" href="./assets/js/11.bcef3326.js"><link rel="prefetch" href="./assets/js/12.875a5077.js"><link rel="prefetch" href="./assets/js/13.e8cbeb70.js"><link rel="prefetch" href="./assets/js/14.2c39dfdb.js"><link rel="prefetch" href="./assets/js/15.7ceb0a07.js"><link rel="prefetch" href="./assets/js/16.eb41b9c4.js"><link rel="prefetch" href="./assets/js/17.40b8e7d6.js"><link rel="prefetch" href="./assets/js/18.b6ebb251.js"><link rel="prefetch" href="./assets/js/19.e2164a51.js"><link rel="prefetch" href="./assets/js/20.e7f3dee5.js"><link rel="prefetch" href="./assets/js/21.b890ad49.js"><link rel="prefetch" href="./assets/js/22.5f904fe6.js"><link rel="prefetch" href="./assets/js/23.5a4826a7.js"><link rel="prefetch" href="./assets/js/24.7e26d504.js"><link rel="prefetch" href="./assets/js/25.12cb1be6.js"><link rel="prefetch" href="./assets/js/26.abc4e572.js"><link rel="prefetch" href="./assets/js/27.825b6e98.js"><link rel="prefetch" href="./assets/js/28.62ad870b.js"><link rel="prefetch" href="./assets/js/29.7c91b9e0.js"><link rel="prefetch" href="./assets/js/3.b2a821f9.js"><link rel="prefetch" href="./assets/js/30.6445e332.js"><link rel="prefetch" href="./assets/js/31.818f2972.js"><link rel="prefetch" href="./assets/js/32.3d92a377.js"><link rel="prefetch" href="./assets/js/33.00e6842b.js"><link rel="prefetch" href="./assets/js/34.c808eb2f.js"><link rel="prefetch" href="./assets/js/35.92dce0b1.js"><link rel="prefetch" href="./assets/js/36.d7ab0eb0.js"><link rel="prefetch" href="./assets/js/37.b4546743.js"><link rel="prefetch" href="./assets/js/38.4255021f.js"><link rel="prefetch" href="./assets/js/39.2e98ff62.js"><link rel="prefetch" href="./assets/js/4.77f39342.js"><link rel="prefetch" href="./assets/js/40.e2a68677.js"><link rel="prefetch" href="./assets/js/41.4a5eb6ae.js"><link rel="prefetch" href="./assets/js/42.16f5decc.js"><link rel="prefetch" href="./assets/js/43.9cfe69fd.js"><link rel="prefetch" href="./assets/js/44.83a300d4.js"><link rel="prefetch" href="./assets/js/45.39d53b8d.js"><link rel="prefetch" href="./assets/js/46.6f1d4589.js"><link rel="prefetch" href="./assets/js/47.2cf82cbc.js"><link rel="prefetch" href="./assets/js/48.0f5ce20f.js"><link rel="prefetch" href="./assets/js/49.11b01268.js"><link rel="prefetch" href="./assets/js/5.8167eb95.js"><link rel="prefetch" href="./assets/js/50.1951fa53.js"><link rel="prefetch" href="./assets/js/51.84a08f5b.js"><link rel="prefetch" href="./assets/js/52.be665098.js"><link rel="prefetch" href="./assets/js/54.35559a02.js"><link rel="prefetch" href="./assets/js/55.d37bca22.js"><link rel="prefetch" href="./assets/js/56.5ecb2f9f.js"><link rel="prefetch" href="./assets/js/58.04c2e7cc.js"><link rel="prefetch" href="./assets/js/59.c4bc7d31.js"><link rel="prefetch" href="./assets/js/6.2d72af7d.js"><link rel="prefetch" href="./assets/js/60.1392f7eb.js"><link rel="prefetch" href="./assets/js/61.be8e5fae.js"><link rel="prefetch" href="./assets/js/62.a4cfb5a2.js"><link rel="prefetch" href="./assets/js/63.34ec5cb4.js"><link rel="prefetch" href="./assets/js/64.8e519149.js"><link rel="prefetch" href="./assets/js/65.33272212.js"><link rel="prefetch" href="./assets/js/66.a602e63b.js"><link rel="prefetch" href="./assets/js/67.86904605.js"><link rel="prefetch" href="./assets/js/68.e956541b.js"><link rel="prefetch" href="./assets/js/69.2b456f4d.js"><link rel="prefetch" href="./assets/js/7.663f1027.js"><link rel="prefetch" href="./assets/js/70.747cff8b.js"><link rel="prefetch" href="./assets/js/71.cacc5c8a.js"><link rel="prefetch" href="./assets/js/72.f0d52bd1.js"><link rel="prefetch" href="./assets/js/73.2d1700b0.js"><link rel="prefetch" href="./assets/js/74.ccf9952d.js"><link rel="prefetch" href="./assets/js/75.ca425686.js"><link rel="prefetch" href="./assets/js/76.617e54c8.js"><link rel="prefetch" href="./assets/js/77.f6942721.js"><link rel="prefetch" href="./assets/js/78.0960ed5d.js"><link rel="prefetch" href="./assets/js/79.324b5274.js"><link rel="prefetch" href="./assets/js/8.a5c0aeae.js"><link rel="prefetch" href="./assets/js/80.ae0a68ce.js"><link rel="prefetch" href="./assets/js/81.db89ca3b.js"><link rel="prefetch" href="./assets/js/82.c41eea7e.js"><link rel="prefetch" href="./assets/js/83.44f928b1.js"><link rel="prefetch" href="./assets/js/84.8f493f23.js"><link rel="prefetch" href="./assets/js/85.919aa2be.js"><link rel="prefetch" href="./assets/js/86.95e90d73.js"><link rel="prefetch" href="./assets/js/87.4d90dd23.js"><link rel="prefetch" href="./assets/js/88.385dbbe9.js"><link rel="prefetch" href="./assets/js/89.4d6ef5c9.js"><link rel="prefetch" href="./assets/js/9.871d87b0.js"><link rel="prefetch" href="./assets/js/90.e6d3ff37.js"><link rel="prefetch" href="./assets/js/91.d5b6ebe5.js"><link rel="prefetch" href="./assets/js/92.c71e0aed.js"><link rel="prefetch" href="./assets/js/93.c3fe4520.js"><link rel="prefetch" href="./assets/js/94.4a43d9f7.js"><link rel="prefetch" href="./assets/js/95.d42baccf.js"><link rel="prefetch" href="./assets/js/96.c176c058.js"><link rel="prefetch" href="./assets/js/97.5fe590f8.js"><link rel="prefetch" href="./assets/js/98.d65f7c92.js"><link rel="prefetch" href="./assets/js/99.d452495a.js">
    <link rel="stylesheet" href="./assets/css/0.styles.21cd1aa6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">程序员徐婵</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/./summarize/" class="nav-link">
  低代码
</a></div><div class="nav-item"><a href="/./blog/underscore/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/./openSource/start/" class="nav-link">
  开源
</a></div> <a href="https://github.com/GitXuchan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/./summarize/" class="nav-link">
  低代码
</a></div><div class="nav-item"><a href="/./blog/underscore/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/./openSource/start/" class="nav-link">
  开源
</a></div> <a href="https://github.com/GitXuchan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>日常博客</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./blog/performance/1.html" class="sidebar-link">webpack 性能调优与 Gzip 原理</a></li><li><a href="/./blog/tabbar/" class="sidebar-link">小程序自定义TabBar</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="微信小程序canvas"><a href="#微信小程序canvas" class="header-anchor">#</a> 微信小程序canvas</h1> <p>近期，电商直播业务热火朝天，直播间有一个很重要的互动：点赞。</p> <p>为了烘托直播间的氛围，直播相对于普通视频或者文本内容，点赞通常有两个特殊需求：</p> <p>点赞动作次数不限制，引导用户疯狂点赞
直播间的所有疯狂点赞，都需要在所有用户界面都动画展现出来
我们先来看点赞效果图：
<img src="https://img-blog.csdnimg.cn/20210427231549948.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2MTgwNzY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p>从效果图上我们还看到有几点重要信息：</p> <ul><li>点赞动画图片大小不一，运动轨迹也是随机的。</li> <li>点赞动画图片都是先放大再匀速运动。</li> <li>快到顶部的时候，逐渐缩小并消失。</li> <li>收到大量的点赞请求的时候，点赞动画不扎堆，井然有序持续出现。</li> <li>刚接到这个需求的时候，考虑过CSS 动画实现，但是 CSS 需要手动清除节点来防止节点过多而造成的性能问题。同时 CSS 动画在部分 iphone 机型上会偶现“闪烁”现象。综合考虑，选择用canvas实现。</li></ul> <p>下面介绍实现原理和踩过的那些坑。</p> <h2 id="_1-canvas-绘图实现原理"><a href="#_1-canvas-绘图实现原理" class="header-anchor">#</a> 1 Canvas 绘图实现原理</h2> <h3 id="_1-1-初始化"><a href="#_1-1-初始化" class="header-anchor">#</a> 1.1 初始化</h3> <p>页面元素上新建 canvas 标签，初始化 canvas。</p> <p>canvas 上可以设置 width 和 height 属性，也可以在 style 属性里面设置 width 和 height。</p> <p>style 中的 width 和 height 分别代表 canvas 这个元素在界面上所占据的宽高，即样式上的宽高。attribute 中的 width 和 height 则代表 canvas 实际像素的宽高。
使用 Canvas 2D 可以使微信小程序环境中的 Canvas 与 W3C 标准 Canvas 接口更为接近，因而可以解决之前接口实现不一致引起的 bug。并且，Canvas 2D 的同层渲染可以解决图表与其他原生组件覆盖层级的问题。 想要进一步了解同层渲染的原理，可以参考这篇文章——《小程序同层渲染原理剖析》。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>canvas id<span class="token operator">=</span><span class="token string">&quot;likestar&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;2d&quot;</span> width<span class="token operator">=</span><span class="token string">&quot;{{realWidth}}&quot;</span> height<span class="token operator">=</span><span class="token string">&quot;{{realHeight}}&quot;</span> style<span class="token operator">=</span><span class="token string">&quot;width: {{ width }}rpx; height: {{ height }}rpx;&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;like-fx wr-class&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>canvas<span class="token operator">&gt;</span>
</code></pre></div><h3 id="_1-2-提前加载图片资源"><a href="#_1-2-提前加载图片资源" class="header-anchor">#</a> 1.2 提前加载图片资源</h3> <p>将需要随机渲染的点赞图片，先预加载，获得图片的宽高，如果有下载失败的，则不显示该随机图片即可。
<img src="https://img-blog.csdnimg.cn/20210427231634638.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2MTgwNzY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p>由于 canvas 不是矢量图，而是像图片一样是位图模式的。高 dpi 显示设备意味着每平方英寸有更多的像素。也就是说二倍屏，浏览器就会以 2 个像素点的宽度来渲染一个像素，该 canvas 在 Retina 屏幕下相当于占据了 2 倍的空间，相当于图片被放大了一倍，因此绘制出来的图片文字等会变模糊。</p> <p>因此，要做 Retina 屏适配，关键是知道当前屏幕的设备像素比，将 canvas 放大到该设备像素比来绘制，然后将 canvas 压缩到一倍来展示。</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// 创建canvas上下文</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSelectorQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'#likestar'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">node</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> canvas <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>node<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>getContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 缩放canvs画布解决高清屏幕模糊问题</span>
            <span class="token keyword">const</span> dpr <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getSystemInfoSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pixelRatio<span class="token punctuation">;</span>
            canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>realWidth <span class="token operator">*</span> dpr<span class="token punctuation">;</span>
            canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>realHeight <span class="token operator">*</span> dpr<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>dpr<span class="token punctuation">,</span> dpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> likeImgae <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              likeImgae<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://***.**.***.com/mp/like-animation/like</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
              likeImgae<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>likeImgList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>likeImgae<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_1-3-创建渲染对象"><a href="#_1-3-创建渲染对象" class="header-anchor">#</a> 1.3 创建渲染对象</h2> <h3 id="_1-3-1-气泡属性概览"><a href="#_1-3-1-气泡属性概览" class="header-anchor">#</a> 1.3.1 气泡属性概览</h3> <p>每个点赞气泡对象包含如下参数：</p> <p>id：每个气泡拥有独立的 ID，便于控制
opacity：点赞气泡上升到顶部时逐渐消失，需要设置透明度
pathData：气泡的运动路径
image：预加载的气泡图片列表中随机选择一张图片作为气泡图
factor: 运动参数，包含该气泡运动的速度和贝塞尔曲线系数
width: 当前气泡的大小</p> <div class="language-js extra-class"><pre class="language-js"><code>      <span class="token keyword">const</span> anmationData <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//透明度</span>
        <span class="token literal-property property">pathData</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generatePathData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generatePathDataReverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 路径</span>
        <span class="token literal-property property">image</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>likeImgList<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">factor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">speed</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.014</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 运动速度，值越小越慢</span>
          <span class="token literal-property property">t</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//  贝塞尔函数系数</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iconWidth <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-3-2-曲线路径生成"><a href="#_1-3-2-曲线路径生成" class="header-anchor">#</a> 1.3.2 曲线路径生成</h3> <p>实时渲染图片，使其变成一个连贯的动画，很重要的是：生成曲线轨迹。这个曲线轨迹需要是平滑的均匀曲线。 假如生成的曲线轨迹不平滑的话，那看到的效果就会太突兀，比如上一个是 10 px，下一个就是 -10px，那显然，动画就是忽左忽右左右闪烁了。 理想的轨迹是上一个位置是 10px,接下来是 9px，然后一直平滑到 -10px，这样的坐标点就是连贯的，看起来动画就是平滑运行。</p> <p><img src="https://img-blog.csdnimg.cn/20210427231652904.png" alt="在这里插入图片描述"></p> <p>canvas 动画中常使用贝塞尔曲线来平滑路径，本次动画应用的是四阶贝塞尔曲线，如上图所示。贝塞尔曲线原理可参考下面两篇文章：</p> <ul><li>深入理解贝塞尔曲线</li> <li>如何理解并应用贝塞尔曲线
<img src="https://img-blog.csdnimg.cn/20210427231701279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2MTgwNzY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li></ul> <p>首先，随机生成四个点，作为气泡的运动路径，为了保证气泡的随机性，使气泡不扎堆，将每个点的位置范围都设置为一个区间。</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token function">generatePathData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> realWidth<span class="token punctuation">,</span> realHeight <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p0 <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span> <span class="token operator">*</span> realWidth<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> realHeight<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> realWidth<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.85</span><span class="token punctuation">)</span> <span class="token operator">*</span> realHeight<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> realWidth<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> realHeight<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.04</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span> <span class="token operator">*</span> realWidth<span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span> <span class="token operator">*</span> realHeight<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>通过运动路径四个点的坐标和贝塞尔曲线系数，更新气泡下一步的位置信息[x,y]。</p> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token comment">/**更新气泡的最新运动路径 */</span>
  <span class="token function">updatePath</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> factor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> p0 <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p1 <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p2 <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> p3 <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> factor<span class="token punctuation">;</span>

    <span class="token comment">/*贝塞尔曲线，计算多项式系数*/</span>
    <span class="token keyword">const</span> cx1 <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p1<span class="token punctuation">.</span>x <span class="token operator">-</span> p0<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> bx1 <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>x <span class="token operator">-</span> p1<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> cx1<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ax1 <span class="token operator">=</span> p3<span class="token punctuation">.</span>x <span class="token operator">-</span> p0<span class="token punctuation">.</span>x <span class="token operator">-</span> cx1 <span class="token operator">-</span> bx1<span class="token punctuation">;</span>

    <span class="token keyword">const</span> cy1 <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p1<span class="token punctuation">.</span>y <span class="token operator">-</span> p0<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> by1 <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p2<span class="token punctuation">.</span>y <span class="token operator">-</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">-</span> cy1<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ay1 <span class="token operator">=</span> p3<span class="token punctuation">.</span>y <span class="token operator">-</span> p0<span class="token punctuation">.</span>y <span class="token operator">-</span> cy1 <span class="token operator">-</span> by1<span class="token punctuation">;</span>

    <span class="token keyword">const</span> x <span class="token operator">=</span> ax1 <span class="token operator">*</span> <span class="token punctuation">(</span>t <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">)</span> <span class="token operator">+</span> bx1 <span class="token operator">*</span> <span class="token punctuation">(</span>t <span class="token operator">*</span> t<span class="token punctuation">)</span> <span class="token operator">+</span> cx1 <span class="token operator">*</span> t <span class="token operator">+</span> p0<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> ay1 <span class="token operator">*</span> <span class="token punctuation">(</span>t <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">)</span> <span class="token operator">+</span> by1 <span class="token operator">*</span> <span class="token punctuation">(</span>t <span class="token operator">*</span> t<span class="token punctuation">)</span> <span class="token operator">+</span> cy1 <span class="token operator">*</span> t <span class="token operator">+</span> p0<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">,</span>
      y<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-3-3-放大缩小淡出"><a href="#_1-3-3-放大缩小淡出" class="header-anchor">#</a> 1.3.3 放大缩小淡出</h3> <p>从效果图中可知，点赞动画都是先放大然后匀速运动，在最后四分之一的路程中逐渐缩小并淡出。可以通过控制该气泡的width和opacity属性来实现。</p> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token keyword">const</span> anmationData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span><span class="token operator">+</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updatePath</span><span class="token punctuation">(</span>
        anmationData<span class="token punctuation">.</span>pathData<span class="token punctuation">,</span>
        anmationData<span class="token punctuation">.</span>factor<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> speed <span class="token punctuation">}</span> <span class="token operator">=</span> anmationData<span class="token punctuation">.</span>factor<span class="token punctuation">;</span>
      anmationData<span class="token punctuation">.</span>factor<span class="token punctuation">.</span>t <span class="token operator">+=</span> speed<span class="token punctuation">;</span>

      <span class="token keyword">let</span> curWidth <span class="token operator">=</span> anmationData<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span> <span class="token number">0.25</span> <span class="token operator">*</span> realHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        curWidth <span class="token operator">=</span> <span class="token punctuation">(</span>realHeight <span class="token operator">-</span> y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.5</span><span class="token punctuation">;</span>
        curWidth <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>anmationData<span class="token punctuation">.</span>width<span class="token punctuation">,</span> curWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        curWidth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.75</span> <span class="token operator">+</span> y <span class="token operator">/</span> realHeight<span class="token punctuation">)</span> <span class="token operator">*</span> anmationData<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">let</span> curAlpha <span class="token operator">=</span> anmationData<span class="token punctuation">.</span>opacity<span class="token punctuation">;</span>
      curAlpha <span class="token operator">=</span> y <span class="token operator">/</span> realHeight<span class="token punctuation">;</span>
      curAlpha <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> curAlpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> curAlpha<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
        anmationData<span class="token punctuation">.</span>image<span class="token punctuation">,</span>
        x <span class="token operator">-</span> curWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        y<span class="token punctuation">,</span>
        curWidth<span class="token punctuation">,</span>
        curWidth<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-3-4-边界处理和气泡管理"><a href="#_1-3-4-边界处理和气泡管理" class="header-anchor">#</a> 1.3.4 边界处理和气泡管理</h3> <p>当气泡超出画布边界，会产生截断的效果，需要删除气泡。
同时，当贝塞尔曲线系数大于 1 时，表示该气泡已经走完完整路程，可以删除。
及时清理气泡对象可以有效防止内存泄漏。</p> <div class="language-js extra-class"><pre class="language-js"><code>      <span class="token comment">// 贝塞尔曲线系数大于1，删除该气泡</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>anmationData<span class="token punctuation">.</span>factor<span class="token punctuation">.</span>t <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span> realHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> anmationData<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre></div><h2 id="_1-4-动画绘制原理"><a href="#_1-4-动画绘制原理" class="header-anchor">#</a> 1.4 动画绘制原理</h2> <h3 id="_1-4-1-点赞气泡生成"><a href="#_1-4-1-点赞气泡生成" class="header-anchor">#</a> 1.4.1 点赞气泡生成</h3> <p>通过监听点赞数count的变化来生成气泡，用户每点赞一次，或者接收到 IM 推送的点赞数目更新，就生成气泡并放入渲染实例队列。</p> <p>用户自己点赞的时候，随机生成 1-3 个气泡，IM 推送新的点赞数目时，随机生成 2-6 个气泡。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**点赞个数变化 */</span>
  <span class="token function">likeChange</span><span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this.ctx初始化才能触发点赞个数变化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">&amp;&amp;</span> newVal <span class="token operator">-</span> oldVal <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>likeImgList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 自己点赞的时候，随机 1-3个气泡，im推送更新的时候，随机2-6个气泡</span>
      <span class="token keyword">const</span> count <span class="token operator">=</span>
        newVal <span class="token operator">-</span> oldVal <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">likeClick</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>随机生成每个气泡的对象属性，放入渲染实例队列。第一个气泡进入队列，开启点赞动画，平均每 20s 刷新一次图层。
这里为了增强气泡运动轨迹的随机性，定义气泡的镜像运动路径generatePathDataReverse。
为了使同一时间生成的多个气泡不扎堆重叠，将气泡的运动速度设为一个区间[0.01,0.014]。
为了增强层次感，将气泡的大小也设置为一个区间[0.9,1.1]。</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">/**点赞函数，参数 count 表示一次点赞同时出现的气泡数量*/</span>
  <span class="token function">likeClick</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> length <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>likeImgList<span class="token punctuation">;</span>
    <span class="token keyword">const</span> curId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>likeImgList<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> anmationData <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> curId <span class="token operator">+</span> i<span class="token punctuation">,</span>
        <span class="token literal-property property">timer</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 定时器</span>
        <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//透明度</span>
        <span class="token literal-property property">pathData</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generatePathData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generatePathDataReverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 路径</span>
        <span class="token literal-property property">image</span><span class="token operator">:</span> image<span class="token punctuation">,</span>
        <span class="token literal-property property">factor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">speed</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.014</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 运动速度，值越小越慢</span>
          <span class="token literal-property property">t</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//  贝塞尔函数系数</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iconWidth <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> anmationData<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> anmationData<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aniFrameId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bubbleAnimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-4-2-动画绘制"><a href="#_1-4-2-动画绘制" class="header-anchor">#</a> 1.4.2 动画绘制</h3> <p>上一步当渲染实例队列放入第一个气泡时，执行bubbleAnimate函数，该函数原理如下：</p> <p>每一帧遍历渲染实例队列的所有气泡对象，更新该气泡的位置坐标、贝塞尔曲线系数、气泡大小和透明度，在画布上绘制该气泡。
从渲染实例队列删除运动结束和超出画布边界的气泡，一是防止内存泄漏， 二是优化定时器执行次数提升性能。
当渲染实例队列气泡数量大于 0 时，设置定时器，每 20ms 循环执行bubbleAnimate函数，更新队列中所有气泡的运动轨迹，直到渲染实例队列清空，删除定时器。
当新的点赞气泡进入时，重新执行bubbleAnimate函数。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**点赞动画 */</span>
  <span class="token function">bubbleAnimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> realHeight<span class="token punctuation">,</span> realWidth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> anmationData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span><span class="token operator">+</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updatePath</span><span class="token punctuation">(</span>
        anmationData<span class="token punctuation">.</span>pathData<span class="token punctuation">,</span>
        anmationData<span class="token punctuation">.</span>factor<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> speed <span class="token punctuation">}</span> <span class="token operator">=</span> anmationData<span class="token punctuation">.</span>factor<span class="token punctuation">;</span>
      anmationData<span class="token punctuation">.</span>factor<span class="token punctuation">.</span>t <span class="token operator">+=</span> speed<span class="token punctuation">;</span>

      <span class="token keyword">let</span> curWidth <span class="token operator">=</span> anmationData<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span> <span class="token number">0.25</span> <span class="token operator">*</span> realHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        curWidth <span class="token operator">=</span> <span class="token punctuation">(</span>realHeight <span class="token operator">-</span> y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.5</span><span class="token punctuation">;</span>
        curWidth <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>anmationData<span class="token punctuation">.</span>width<span class="token punctuation">,</span> curWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        curWidth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.75</span> <span class="token operator">+</span> y <span class="token operator">/</span> realHeight<span class="token punctuation">)</span> <span class="token operator">*</span> anmationData<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">let</span> curAlpha <span class="token operator">=</span> anmationData<span class="token punctuation">.</span>opacity<span class="token punctuation">;</span>
      curAlpha <span class="token operator">=</span> y <span class="token operator">/</span> realHeight<span class="token punctuation">;</span>
      curAlpha <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> curAlpha<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> curAlpha<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
        anmationData<span class="token punctuation">.</span>image<span class="token punctuation">,</span>
        x <span class="token operator">-</span> curWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        y<span class="token punctuation">,</span>
        curWidth<span class="token punctuation">,</span>
        curWidth<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 贝塞尔曲线系数大于1，删除该气泡</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>anmationData<span class="token punctuation">.</span>factor<span class="token punctuation">.</span>t <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span> realHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> anmationData<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每20ms刷新一次图层</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>aniFrameId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> realWidth<span class="token punctuation">,</span> realHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bubbleAnimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> realWidth<span class="token punctuation">,</span> realHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aniFrameId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>aniFrameId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="_1-5-清除渲染实例队列"><a href="#_1-5-清除渲染实例队列" class="header-anchor">#</a> 1.5 清除渲染实例队列</h2> <p>开发期间曾遇见这样一个 bug，在直播间进行点赞，退出直播间重新进入时，可能导致点赞动画失效。bug 出现的原因在于退出直播间时，没有及时清空渲染实例队列中的气泡，这导致队列中的气泡数量恒大于 0，不会执行bubbleAnimate函数。</p> <div class="language-js extra-class"><pre class="language-js"><code>      <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> anmationData<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">[</span>anmationData<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> anmationData<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bubbleAnimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre></div><p>解决方法就是在组件实例被从页面节点树移除时清除定时器并清空渲染实例队列的所有气泡。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 删除定时器，同时删除剩下的其他节点</span>
  <span class="token function">detached</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> realHeight<span class="token punctuation">,</span> realWidth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aniFrameId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> realWidth<span class="token punctuation">,</span> realHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aniFrameId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>aniFrameId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="_1-7-旧版本的动画效果图"><a href="#_1-7-旧版本的动画效果图" class="header-anchor">#</a> 1.7 旧版本的动画效果图</h2> <p>此动画已经迭代了三个版本，此处附上旧版本的动画效果图。
<img src="https://img-blog.csdnimg.cn/20210427231715849.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2MTgwNzY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>新人上路，第一次写文章，多有不足指出，欢迎指教。</p> <p>最后的最后，欢迎讨论，点个赞再走吧 ｡◕‿◕｡ ～</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">11/30/2021, 6:31:05 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.6fdaac57.js" defer></script><script src="./assets/js/53.a6c4e3ad.js" defer></script><script src="./assets/js/2.e424c73a.js" defer></script><script src="./assets/js/57.61cb8b5f.js" defer></script>
  </body>
</html>
