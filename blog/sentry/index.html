<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>No.5 学习 sentry 源码整体架构，打造属于自己的前端异常监控SDK | 程序员徐婵</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="/assets/js/autopush-baidu.js"></script>
    <script src="/assets/js/autopush-360.js"></script>
    <meta name="description" content="徐婵个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.ec0b3ca3.css" as="style"><link rel="preload" href="/assets/js/app.b6963aae.js" as="script"><link rel="preload" href="/assets/js/52.44f85c15.js" as="script"><link rel="preload" href="/assets/js/2.6f0b2cdc.js" as="script"><link rel="preload" href="/assets/js/7.e12f106b.js" as="script"><link rel="prefetch" href="/assets/js/10.90c2f098.js"><link rel="prefetch" href="/assets/js/100.b12e9d57.js"><link rel="prefetch" href="/assets/js/101.4997d2d5.js"><link rel="prefetch" href="/assets/js/102.e96ce1ac.js"><link rel="prefetch" href="/assets/js/103.c1b45184.js"><link rel="prefetch" href="/assets/js/104.0ec6ceaf.js"><link rel="prefetch" href="/assets/js/105.3e911a4c.js"><link rel="prefetch" href="/assets/js/106.35936a1d.js"><link rel="prefetch" href="/assets/js/107.fddd64fd.js"><link rel="prefetch" href="/assets/js/108.719856a3.js"><link rel="prefetch" href="/assets/js/11.2103f09d.js"><link rel="prefetch" href="/assets/js/12.c5cd7927.js"><link rel="prefetch" href="/assets/js/13.be925ff6.js"><link rel="prefetch" href="/assets/js/14.8d69a969.js"><link rel="prefetch" href="/assets/js/15.c348dc1c.js"><link rel="prefetch" href="/assets/js/16.cdf9e14c.js"><link rel="prefetch" href="/assets/js/17.aa08b51b.js"><link rel="prefetch" href="/assets/js/18.4372e494.js"><link rel="prefetch" href="/assets/js/19.5bbd9991.js"><link rel="prefetch" href="/assets/js/20.1c549a1a.js"><link rel="prefetch" href="/assets/js/21.0c331716.js"><link rel="prefetch" href="/assets/js/22.78818f83.js"><link rel="prefetch" href="/assets/js/23.3230cdc1.js"><link rel="prefetch" href="/assets/js/24.eb244d60.js"><link rel="prefetch" href="/assets/js/25.35864aeb.js"><link rel="prefetch" href="/assets/js/26.28833456.js"><link rel="prefetch" href="/assets/js/27.f26ff805.js"><link rel="prefetch" href="/assets/js/28.fe181df6.js"><link rel="prefetch" href="/assets/js/29.a859df2d.js"><link rel="prefetch" href="/assets/js/3.e65d6a99.js"><link rel="prefetch" href="/assets/js/30.50abe8c6.js"><link rel="prefetch" href="/assets/js/31.370385a8.js"><link rel="prefetch" href="/assets/js/32.4bcb4cb5.js"><link rel="prefetch" href="/assets/js/33.8ffa42cc.js"><link rel="prefetch" href="/assets/js/34.9157c935.js"><link rel="prefetch" href="/assets/js/35.f6cbde08.js"><link rel="prefetch" href="/assets/js/36.f8d2f26b.js"><link rel="prefetch" href="/assets/js/37.96c2da47.js"><link rel="prefetch" href="/assets/js/38.0dcb94fd.js"><link rel="prefetch" href="/assets/js/39.3f7c9b11.js"><link rel="prefetch" href="/assets/js/4.26791883.js"><link rel="prefetch" href="/assets/js/40.93a02ab4.js"><link rel="prefetch" href="/assets/js/41.f568a99e.js"><link rel="prefetch" href="/assets/js/42.37aa1cb4.js"><link rel="prefetch" href="/assets/js/43.d99217cf.js"><link rel="prefetch" href="/assets/js/44.bdc6d3d4.js"><link rel="prefetch" href="/assets/js/45.c2d267f6.js"><link rel="prefetch" href="/assets/js/46.dbf173b1.js"><link rel="prefetch" href="/assets/js/47.a662ec3a.js"><link rel="prefetch" href="/assets/js/48.f9c47b12.js"><link rel="prefetch" href="/assets/js/49.6ee8abcd.js"><link rel="prefetch" href="/assets/js/5.afcb1b61.js"><link rel="prefetch" href="/assets/js/50.147dbf16.js"><link rel="prefetch" href="/assets/js/51.874d041d.js"><link rel="prefetch" href="/assets/js/53.cb1147bd.js"><link rel="prefetch" href="/assets/js/54.5fdeea6c.js"><link rel="prefetch" href="/assets/js/55.b51d0de0.js"><link rel="prefetch" href="/assets/js/56.6e4fe13a.js"><link rel="prefetch" href="/assets/js/57.95937602.js"><link rel="prefetch" href="/assets/js/58.705da4d8.js"><link rel="prefetch" href="/assets/js/59.4174e56f.js"><link rel="prefetch" href="/assets/js/6.42734b81.js"><link rel="prefetch" href="/assets/js/60.aba1438c.js"><link rel="prefetch" href="/assets/js/61.ce399b14.js"><link rel="prefetch" href="/assets/js/62.ad92d1d0.js"><link rel="prefetch" href="/assets/js/63.18a7a278.js"><link rel="prefetch" href="/assets/js/64.6cbeb96e.js"><link rel="prefetch" href="/assets/js/65.a19a5e75.js"><link rel="prefetch" href="/assets/js/66.15862d5b.js"><link rel="prefetch" href="/assets/js/67.11e6a845.js"><link rel="prefetch" href="/assets/js/68.0e9dc545.js"><link rel="prefetch" href="/assets/js/69.f9f6dbe4.js"><link rel="prefetch" href="/assets/js/70.cf583ba8.js"><link rel="prefetch" href="/assets/js/71.386ac693.js"><link rel="prefetch" href="/assets/js/72.77b344de.js"><link rel="prefetch" href="/assets/js/73.106ef205.js"><link rel="prefetch" href="/assets/js/74.f9d6cff5.js"><link rel="prefetch" href="/assets/js/75.f88f281a.js"><link rel="prefetch" href="/assets/js/76.df251ece.js"><link rel="prefetch" href="/assets/js/77.429b9a9c.js"><link rel="prefetch" href="/assets/js/78.9149213c.js"><link rel="prefetch" href="/assets/js/79.a74930d7.js"><link rel="prefetch" href="/assets/js/8.483425da.js"><link rel="prefetch" href="/assets/js/80.30145abd.js"><link rel="prefetch" href="/assets/js/81.0a7d6ece.js"><link rel="prefetch" href="/assets/js/82.0d7ca870.js"><link rel="prefetch" href="/assets/js/83.1644dc36.js"><link rel="prefetch" href="/assets/js/84.497eac65.js"><link rel="prefetch" href="/assets/js/85.60477581.js"><link rel="prefetch" href="/assets/js/86.f6ad2e2d.js"><link rel="prefetch" href="/assets/js/87.bc20dac3.js"><link rel="prefetch" href="/assets/js/88.8d15fec0.js"><link rel="prefetch" href="/assets/js/89.a1c67b29.js"><link rel="prefetch" href="/assets/js/9.03deb81f.js"><link rel="prefetch" href="/assets/js/90.c055dd61.js"><link rel="prefetch" href="/assets/js/91.786907c7.js"><link rel="prefetch" href="/assets/js/92.6bcc50f1.js"><link rel="prefetch" href="/assets/js/93.fcfebcf1.js"><link rel="prefetch" href="/assets/js/94.4e176809.js"><link rel="prefetch" href="/assets/js/95.e9216d69.js"><link rel="prefetch" href="/assets/js/96.0783f841.js"><link rel="prefetch" href="/assets/js/97.47ca6f43.js"><link rel="prefetch" href="/assets/js/98.a69e36ba.js"><link rel="prefetch" href="/assets/js/99.7cfe3715.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ec0b3ca3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">程序员徐婵</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/summarize/" class="nav-link">
  低代码
</a></div><div class="nav-item"><a href="/blog/underscore/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/openSource/start/" class="nav-link">
  开源
</a></div> <a href="https://github.com/GitXuchan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/summarize/" class="nav-link">
  低代码
</a></div><div class="nav-item"><a href="/blog/underscore/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/openSource/start/" class="nav-link">
  开源
</a></div> <a href="https://github.com/GitXuchan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>日常博客</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/performance/1.html" class="sidebar-link">webpack 性能调优与 Gzip 原理</a></li><li><a href="/blog/tabbar/" class="sidebar-link">小程序自定义TabBar</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="no-5-学习-sentry-源码整体架构-打造属于自己的前端异常监控sdk"><a href="#no-5-学习-sentry-源码整体架构-打造属于自己的前端异常监控sdk" class="header-anchor">#</a> No.5 学习 sentry 源码整体架构，打造属于自己的前端异常监控SDK</h1> <h2 id="_1-前言"><a href="#_1-前言" class="header-anchor">#</a> 1. 前言</h2> <p>源码类文章，一般阅读量不高。已经有能力看懂的，自己就看了。不想看，不敢看的就不会去看源码。<br>
所以我的文章，尽量写得让想看源码又不知道怎么看的读者能看懂。</p> <p><strong>导读</strong><br>
本文通过梳理前端错误监控知识、介绍<code>sentry</code>错误监控原理、<code>sentry</code>初始化、<code>Ajax</code>上报、<code>window.onerror、window.onunhandledrejection</code>几个方面来学习<code>sentry</code>的源码。</p> <p>开发微信小程序，想着搭建小程序错误监控方案。最近用了丁香园 开源的<code>Sentry</code> 小程序 <code>SDK</code><a href="https://github.com/lizhiyao/sentry-miniapp" target="_blank" rel="noopener noreferrer">sentry-miniapp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。
顺便研究下<a href="https://github.com/getsentry/sentry-javascript" target="_blank" rel="noopener noreferrer"><code>sentry-javascript</code>仓库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的源码整体架构，于是有了这篇文章。</p> <p>本文分析的是打包后未压缩的源码，源码总行数五千余行，链接地址是：<a href="https://browser.sentry-cdn.com/5.7.1/bundle.js" target="_blank" rel="noopener noreferrer">https://browser.sentry-cdn.com/5.7.1/bundle.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>， 版本是<code>v5.7.1</code>。</p> <p>本文示例等源代码在这我的<code>github</code>博客中<a href="https://github.com/lxchuan12/blog/blob/master/docs/sentry/README.md" target="_blank" rel="noopener noreferrer">github blog sentry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，需要的读者可以点击查看，如果觉得不错，可以顺便<code>star</code>一下。</p> <p>看源码前先来梳理下前端错误监控的知识。</p> <h2 id="_2-前端错误监控知识"><a href="#_2-前端错误监控知识" class="header-anchor">#</a> 2. 前端错误监控知识</h2> <p>摘抄自 <a href="https://coding.imooc.com/class/129.html" target="_blank" rel="noopener noreferrer">慕课网视频教程：前端跳槽面试必备技巧<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://articles.jerryshi.com/learning/fe/js-interview-skill.html#_4-4-%E9%94%99%E8%AF%AF%E7%9B%91%E6%8E%A7%E7%B1%BB" target="_blank" rel="noopener noreferrer">别人做的笔记：前端跳槽面试必备技巧-4-4 错误监控类<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_2-1-前端错误的分类"><a href="#_2-1-前端错误的分类" class="header-anchor">#</a> 2.1 前端错误的分类</h3> <blockquote><p><strong>1.即时运行错误：代码错误</strong></p></blockquote> <p><code>try...catch</code></p> <p><code>window.onerror</code> (也可以用<code>DOM2</code>事件监听)</p> <blockquote><p><strong>2.资源加载错误</strong></p></blockquote> <p><code>object.onerror</code>: <code>dom</code>对象的<code>onerror</code>事件</p> <p><code>performance.getEntries()</code></p> <p><code>Error</code>事件捕获</p> <blockquote><p>3.<strong>使用<code>performance.getEntries()</code>获取网页图片加载错误</strong></p></blockquote> <p><code>var allImgs = document.getElementsByTagName('image')</code></p> <p><code>var loadedImgs = performance.getEntries().filter(i =&gt; i.initiatorType === 'img')</code></p> <p>最后<code>allIms</code>和<code>loadedImgs</code>对比即可找出图片资源未加载项目</p> <h3 id="_2-2-error事件捕获代码示例"><a href="#_2-2-error事件捕获代码示例" class="header-anchor">#</a> 2.2 Error事件捕获代码示例</h3> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 这里只有捕获才能触发事件，冒泡是不能触发</span>
</code></pre></div><h3 id="_2-3-上报错误的基本原理"><a href="#_2-3-上报错误的基本原理" class="header-anchor">#</a> 2.3 上报错误的基本原理</h3> <p>1.采用<code>Ajax</code>通信的方式上报</p> <p>2.利用<code>Image</code>对象上报 (主流方式)</p> <p><code>Image</code>上报错误方式：
<code>(new Image()).src = 'https://lxchuan12.cn/error?name=若川'</code></p> <h2 id="_3-sentry-前端异常监控基本原理"><a href="#_3-sentry-前端异常监控基本原理" class="header-anchor">#</a> 3. Sentry 前端异常监控基本原理</h2> <blockquote><p>1.重写 <code>window.onerror</code> 方法、重写 <code>window.onunhandledrejection</code> 方法</p></blockquote> <p>如果不了解<code>onerror和onunhandledrejection</code>方法的读者，可以看相关的<code>MDN</code>文档。这里简要介绍一下：</p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror" target="_blank" rel="noopener noreferrer">MDN GlobalEventHandlers.onerror<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'message, source, lineno, colno, error'</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>参数：<br> <code>message</code>：错误信息（字符串）。可用于<code>HTML onerror=&quot;&quot;</code>处理程序中的<code>event</code>。<br> <code>source</code>：发生错误的脚本<code>URL</code>（字符串）<br> <code>lineno</code>：发生错误的行号（数字）<br> <code>colno</code>：发生错误的列号（数字）<br> <code>error</code>：<code>Error</code>对象（对象）<br></p></blockquote> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Events/unhandledrejection" target="_blank" rel="noopener noreferrer">MDN unhandledrejection<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>当 <code>Promise</code> 被 <code>reject</code> 且没有 <code>reject</code> 处理器的时候，会触发 <code>unhandledrejection</code> 事件；这可能发生在 <code>window</code> 下，但也可能发生在 <code>Worker</code> 中。 这对于调试回退错误处理非常有用。</p></blockquote> <p><code>Sentry</code> 源码可以搜索 <code>global.onerror</code> 定位到具体位置</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token class-name">GlobalHandlers</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_installGlobalOnErrorHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 代码有删减</span>
	<span class="token comment">// 这里的 this._global 在浏览器中就是 window</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_oldOnErrorHandler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_global<span class="token punctuation">.</span>onerror<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_global<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> line<span class="token punctuation">,</span> column<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token comment">// code ...</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>同样，可以搜索<code>global.onunhandledrejection</code> 定位到具体位置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">GlobalHandlers</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_installGlobalOnUnhandledRejectionHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 代码有删减</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_oldOnUnhandledRejectionHandler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_global<span class="token punctuation">.</span>onunhandledrejection<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_global<span class="token punctuation">.</span><span class="token function-variable function">onunhandledrejection</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>2.采用<code>Ajax</code>上传</p></blockquote> <p>支持 <code>fetch</code> 使用 <code>fetch</code>，否则使用　<code>XHR</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">BrowserBackend</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_setupTransport</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 代码有删减</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsFetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FetchTransport</span><span class="token punctuation">(</span>transportOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">XHRTransport</span><span class="token punctuation">(</span>transportOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>2.1 <code>fetch</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">FetchTransport</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sendEvent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
		<span class="token literal-property property">referrerPolicy</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">supportsReferrerPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'origin'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>global$2<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> defaultOptions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token literal-property property">status</span><span class="token operator">:</span> exports<span class="token punctuation">.</span>Status<span class="token punctuation">.</span><span class="token function">fromHttpCode</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>2.2 <code>XMLHttpRequest</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">XHRTransport</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sendEvent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SyncPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 熟悉的 XMLHttpRequest</span>
		<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
					<span class="token literal-property property">status</span><span class="token operator">:</span> exports<span class="token punctuation">.</span>Status<span class="token punctuation">.</span><span class="token function">fromHttpCode</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">reject</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> _this<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来主要通过Sentry初始化、如何<code>Ajax上报</code>和<code>window.onerror、window.onunhandledrejection</code>三条主线来学习源码。</p> <blockquote><p>如果看到这里，暂时不想关注后面的源码细节，直接看后文小结1和2的两张图。或者可以点赞或收藏这篇文章，后续想看了再看。</p></blockquote> <h2 id="_4-sentry-源码入口和出口"><a href="#_4-sentry-源码入口和出口" class="header-anchor">#</a> 4. Sentry 源码入口和出口</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Sentry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// code ...</span>

    <span class="token keyword">var</span> <span class="token constant">SDK_NAME</span> <span class="token operator">=</span> <span class="token string">'sentry.javascript.browser'</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> <span class="token constant">SDK_VERSION</span> <span class="token operator">=</span> <span class="token string">'5.7.1'</span><span class="token punctuation">;</span>

	<span class="token comment">// code ...</span>
	<span class="token comment">// 省略了导出的Sentry的若干个方法和属性</span>
	<span class="token comment">// 只列出了如下几个</span>
    exports<span class="token punctuation">.</span><span class="token constant">SDK_NAME</span> <span class="token operator">=</span> <span class="token constant">SDK_NAME</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span><span class="token constant">SDK_VERSION</span> <span class="token operator">=</span> <span class="token constant">SDK_VERSION</span><span class="token punctuation">;</span>
	<span class="token comment">// 重点关注 captureMessage</span>
    exports<span class="token punctuation">.</span>captureMessage <span class="token operator">=</span> captureMessage<span class="token punctuation">;</span>
	<span class="token comment">// 重点关注 init</span>
    exports<span class="token punctuation">.</span>init <span class="token operator">=</span> init<span class="token punctuation">;</span>

    <span class="token keyword">return</span> exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_5-sentry-init-初始化-之-init-函数"><a href="#_5-sentry-init-初始化-之-init-函数" class="header-anchor">#</a> 5. Sentry.init 初始化 之 init 函数</h2> <p>初始化</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里的dsn，是sentry.io网站会生成的。</span>
Sentry<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">dsn</span><span class="token operator">:</span> <span class="token string">'xxx'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// options 是 {dsn: '...'}</span>
<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 如果options 是undefined，则赋值为 空对象</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token comment">// 如果没传 defaultIntegrations 则赋值默认的</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>defaultIntegrations <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		options<span class="token punctuation">.</span>defaultIntegrations <span class="token operator">=</span> defaultIntegrations<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 初始化语句</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>release <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> window_1 <span class="token operator">=</span> <span class="token function">getGlobalObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 这是给  sentry-webpack-plugin 插件提供的，webpack插件注入的变量。这里没用这个插件，所以这里不深究。</span>
		<span class="token comment">// This supports the variable that sentry-webpack-plugin injects</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>window_1<span class="token punctuation">.</span><span class="token constant">SENTRY_RELEASE</span> <span class="token operator">&amp;&amp;</span> window_1<span class="token punctuation">.</span><span class="token constant">SENTRY_RELEASE</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			options<span class="token punctuation">.</span>release <span class="token operator">=</span> window_1<span class="token punctuation">.</span><span class="token constant">SENTRY_RELEASE</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 初始化并且绑定</span>
	<span class="token function">initAndBind</span><span class="token punctuation">(</span>BrowserClient<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-1-getglobalobject、innodeenv-函数"><a href="#_5-1-getglobalobject、innodeenv-函数" class="header-anchor">#</a> 5.1 getGlobalObject、inNodeEnv 函数</h3> <p>很多地方用到这个函数<code>getGlobalObject</code>。其实做的事情也比较简单，就是获取全局对象。浏览器中是<code>window</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 判断是否是node环境
 * Checks whether we're in the Node.js or Browser environment
 *
 * @returns Answer to given question
 */</span>
<span class="token keyword">function</span> <span class="token function">isNodeEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// tslint:disable:strict-type-predicates</span>
	<span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> process <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> process <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object process]'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> fallbackGlobalObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Safely get global scope object
 *
 * @returns Global scope object
 */</span>
<span class="token keyword">function</span> <span class="token function">getGlobalObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">isNodeEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 是 node 环境 赋值给 global</span>
		<span class="token operator">?</span> global
		<span class="token operator">:</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span>
			<span class="token operator">?</span> window
			<span class="token comment">// 不是 window self 不是undefined 说明是 Web Worker 环境</span>
			<span class="token operator">:</span> <span class="token keyword">typeof</span> self <span class="token operator">!==</span> <span class="token string">'undefined'</span>
				<span class="token operator">?</span> self
				<span class="token comment">// 都不是，赋值给空对象。</span>
				<span class="token operator">:</span> fallbackGlobalObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>继续看 <code>initAndBind</code> 函数</p> <h2 id="_6-initandbind-函数之-new-browserclient-options"><a href="#_6-initandbind-函数之-new-browserclient-options" class="header-anchor">#</a> 6. initAndBind 函数之 new BrowserClient(options)</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initAndBind</span><span class="token punctuation">(</span><span class="token parameter">clientClass<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 这里没有开启debug模式，logger.enable() 这句不会执行</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>debug <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">getCurrentHub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">clientClass</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出 <code>initAndBind()</code>，第一个参数是 <code>BrowserClient</code> 构造函数，第二个参数是初始化后的<code>options</code>。
接着先看 构造函数 <code>BrowserClient</code>。
另一条线 <code>getCurrentHub().bindClient()</code> 先不看。</p> <h3 id="_6-1-browserclient-构造函数"><a href="#_6-1-browserclient-构造函数" class="header-anchor">#</a> 6.1 BrowserClient 构造函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> BrowserClient <span class="token operator">=</span> <span class="token comment">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_super</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// `BrowserClient` 继承自`BaseClient`</span>
	<span class="token function">__extends</span><span class="token punctuation">(</span>BrowserClient<span class="token punctuation">,</span> _super<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/**
	 * Creates a new Browser SDK instance.
	 *
	 * @param options Configuration options for this SDK.
	 */</span>
	<span class="token keyword">function</span> <span class="token function">BrowserClient</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token comment">// 把`BrowserBackend`，`options`传参给`BaseClient`调用。</span>
		<span class="token keyword">return</span> <span class="token function">_super</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> BrowserBackend<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> BrowserClient<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span>BaseClient<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>从代码中可以看出</code>：
<code>BrowserClient</code> 继承自<code>BaseClient</code>，并且把<code>BrowserBackend</code>，<code>options</code>传参给<code>BaseClient</code>调用。</p> <p>先看 <code>BrowserBackend</code>，这里的<code>BaseClient</code>，暂时不看。</p> <p>看<code>BrowserBackend</code>之前，先提一下继承、继承静态属性和方法。</p> <h3 id="_6-2-extends、extendstatics-打包代码实现的继承"><a href="#_6-2-extends、extendstatics-打包代码实现的继承" class="header-anchor">#</a> 6.2 __extends、extendStatics 打包代码实现的继承</h3> <p>未打包的源码是使用<code>ES6 extends</code>实现的。这是打包后的对<code>ES6</code>的<code>extends</code>的一种实现。</p> <p>如果对继承还不是很熟悉的读者，可以参考我之前写的文章。<a href="https://juejin.im/post/5c433e216fb9a049c15f841b" target="_blank" rel="noopener noreferrer">面试官问：JS的继承<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 继承静态方法和属性</span>
<span class="token keyword">var</span> <span class="token function-variable function">extendStatics</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 如果支持 Object.setPrototypeOf 这个函数，直接使用</span>
	<span class="token comment">// 不支持，则使用原型__proto__ 属性，</span>
	<span class="token comment">// 如何还不支持（但有可能__proto__也不支持，毕竟是浏览器特有的方法。）</span>
	<span class="token comment">// 则使用for in 遍历原型链上的属性，从而达到继承的目的。</span>
	extendStatics <span class="token operator">=</span> Object<span class="token punctuation">.</span>setPrototypeOf <span class="token operator">||</span>
		<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">__proto__</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> d<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> b<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">||</span>
		<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> p <span class="token keyword">in</span> b<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> d<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">extendStatics</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">__extends</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">extendStatics</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 申明构造函数__ 并且把 d 赋值给 constructor</span>
	<span class="token keyword">function</span> <span class="token function">__</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>constructor <span class="token operator">=</span> d<span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token comment">// (__.prototype = b.prototype, new __()) 这种逗号形式的代码，最终返回是后者，也就是 new __()</span>
	<span class="token comment">// 比如 (typeof null, 1) 返回的是1</span>
	<span class="token comment">// 如果 b === null 用Object.create(b) 创建 ，也就是一个不含原型链等信息的空对象 {}</span>
	<span class="token comment">// 否则使用 new __() 返回</span>
	d<span class="token punctuation">.</span>prototype <span class="token operator">=</span> b <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">__</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> b<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不得不说这打包后的代码十分严谨，上面说的我的文章《面试官问：<code>JS</code>的继承》中没有提到不支持<code>__proto__</code>的情况。看来这文章可以进一步严谨修正了。
让我想起<code>Vue</code>源码中对数组检测代理判断是否支持<code>__proto__</code>的判断。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vuejs 源码：https://github.com/vuejs/vue/blob/dev/dist/vue.js#L526-L527</span>
<span class="token comment">// can we use __proto__?</span>
<span class="token keyword">var</span> hasProto <span class="token operator">=</span> <span class="token string">'__proto__'</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>看完打包代码实现的继承，继续看 <code>BrowserBackend</code> 构造函数</p> <h3 id="_6-3-browserbackend-构造函数-浏览器后端"><a href="#_6-3-browserbackend-构造函数-浏览器后端" class="header-anchor">#</a> 6.3 BrowserBackend  构造函数 （浏览器后端）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> BrowserBackend <span class="token operator">=</span> <span class="token comment">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_super</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">__extends</span><span class="token punctuation">(</span>BrowserBackend<span class="token punctuation">,</span> _super<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">function</span> <span class="token function">BrowserBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> _super <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">_super</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/**
	 * 设置请求
	 */</span>
	<span class="token class-name">BrowserBackend</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_setupTransport</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>dsn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// We return the noop transport here in case there is no Dsn.</span>
			<span class="token comment">// 没有设置dsn，调用BaseBackend.prototype._setupTransport 返回空函数</span>
			<span class="token keyword">return</span> <span class="token class-name">_super</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">_setupTransport</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">var</span> transportOptions <span class="token operator">=</span> <span class="token function">__assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>transportOptions<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">dsn</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>dsn <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>transport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>_options<span class="token punctuation">.</span>transport</span><span class="token punctuation">(</span>transportOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 支持Fetch则返回 FetchTransport 实例，否则返回 XHRTransport实例，</span>
		<span class="token comment">// 这两个构造函数具体代码在开头已有提到。</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsFetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FetchTransport</span><span class="token punctuation">(</span>transportOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">XHRTransport</span><span class="token punctuation">(</span>transportOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// code ...</span>
	<span class="token keyword">return</span> BrowserBackend<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span>BaseBackend<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>BrowserBackend</code> 又继承自 <code>BaseBackend</code>。</p> <h4 id="_6-3-1-basebackend-构造函数-基础后端"><a href="#_6-3-1-basebackend-构造函数-基础后端" class="header-anchor">#</a> 6.3.1 BaseBackend  构造函数 （基础后端）</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * This is the base implemention of a Backend.
 * @hidden
 */</span>
<span class="token keyword">var</span> BaseBackend <span class="token operator">=</span> <span class="token comment">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">/** Creates a new backend instance. */</span>
	<span class="token keyword">function</span> <span class="token function">BaseBackend</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_options <span class="token operator">=</span> options<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>dsn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'No DSN provided, backend will not do anything.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 调用设置请求函数</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_transport <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setupTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/**
	 * Sets up the transport so it can be used later to send requests.
	 * 设置发送请求空函数
	 */</span>
	<span class="token class-name">BaseBackend</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_setupTransport</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NoopTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// code ...</span>
	<span class="token class-name">BaseBackend</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sendEvent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_transport<span class="token punctuation">.</span><span class="token function">sendEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error while sending event: &quot;</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token class-name">BaseBackend</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getTransport</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_transport<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> BaseBackend<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过一系列的继承后，回过头来看 <code>BaseClient</code> 构造函数。</p> <h4 id="_6-3-2-baseclient-构造函数-基础客户端"><a href="#_6-3-2-baseclient-构造函数-基础客户端" class="header-anchor">#</a> 6.3.2 BaseClient 构造函数（基础客户端）</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> BaseClient <span class="token operator">=</span> <span class="token comment">/** @class */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
	 * Initializes this client instance.
	 *
	 * @param backendClass A constructor function to create the backend.
	 * @param options Options for the client.
	 */</span>
	<span class="token keyword">function</span> <span class="token function">BaseClient</span><span class="token punctuation">(</span><span class="token parameter">backendClass<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">/** Array of used integrations. */</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_integrations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token comment">/** Is the client still processing a call? */</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_processing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_backend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">backendClass</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_options <span class="token operator">=</span> options<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>dsn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>_dsn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dsn</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>dsn<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>_integrations <span class="token operator">=</span> <span class="token function">setupIntegrations</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// code ...</span>
	<span class="token keyword">return</span> BaseClient<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-4-小结1-new-browerclient-经过一系列的继承和初始化"><a href="#_6-4-小结1-new-browerclient-经过一系列的继承和初始化" class="header-anchor">#</a> 6.4 小结1. new BrowerClient 经过一系列的继承和初始化</h3> <p>可以输出下具体<code>new clientClass(options)</code>之后的结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initAndBind</span><span class="token punctuation">(</span><span class="token parameter">clientClass<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>debug <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">clientClass</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'new clientClass(options)'</span><span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">getCurrentHub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 原来的代码</span>
	<span class="token comment">// getCurrentHub().bindClient(new clientClass(options));</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最终输出得到这样的数据。我画了一张图表示。重点关注的原型链用颜色标注了，其他部分收缩了。</p> <p><img src="/assets/img/BrowserClient-instance.021e3251.png" alt="sentry new BrowserClient 实例图 By@若川"></p> <h2 id="_7-initandbind-函数之-getcurrenthub-bindclient"><a href="#_7-initandbind-函数之-getcurrenthub-bindclient" class="header-anchor">#</a> 7. initAndBind 函数之 getCurrentHub().bindClient()</h2> <p>继续看 <code>initAndBind</code> 的另一条线。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initAndBind</span><span class="token punctuation">(</span><span class="token parameter">clientClass<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>debug <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">getCurrentHub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">clientClass</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>获取当前的控制中心 <code>Hub</code>，再把<code>new BrowserClient()</code> 的实例对象绑定在<code>Hub</code>上。</p> <h3 id="_7-1-getcurrenthub-函数"><a href="#_7-1-getcurrenthub-函数" class="header-anchor">#</a> 7.1 getCurrentHub 函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取当前Hub 控制中心</span>
<span class="token keyword">function</span> <span class="token function">getCurrentHub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Get main carrier (global for every environment)</span>
	<span class="token keyword">var</span> registry <span class="token operator">=</span> <span class="token function">getMainCarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 如果没有控制中心在载体上，或者它的版本是老版本，就设置新的。</span>
	<span class="token comment">// If there's no hub, or its an old API, assign a new one</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasHubOnCarrier</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getHubFromCarrier</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOlderThan</span><span class="token punctuation">(</span><span class="token constant">API_VERSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setHubOnCarrier</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Hub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// node 才执行</span>
	<span class="token comment">// Prefer domains over global if they are there (applicable only to Node environment)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNodeEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">getHubFromActiveDomain</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 返回当前控制中心来自载体上。</span>
	<span class="token comment">// Return hub that lives on a global object</span>
	<span class="token keyword">return</span> <span class="token function">getHubFromCarrier</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-2-衍生的函数-getmaincarrier、gethubfromcarrier"><a href="#_7-2-衍生的函数-getmaincarrier、gethubfromcarrier" class="header-anchor">#</a> 7.2 衍生的函数 getMainCarrier、getHubFromCarrier</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getMainCarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 载体 这里是window</span>
	<span class="token comment">// 通过一系列new BrowerClient() 一系列的初始化</span>
	<span class="token comment">// 挂载在  carrier.__SENTRY__ 已经有了三个属性，globalEventProcessors, hub, logger</span>
	<span class="token keyword">var</span> carrier <span class="token operator">=</span> <span class="token function">getGlobalObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	carrier<span class="token punctuation">.</span>__SENTRY__ <span class="token operator">=</span> carrier<span class="token punctuation">.</span>__SENTRY__ <span class="token operator">||</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">hub</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> carrier<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取控制中心 hub 从载体上</span>
<span class="token keyword">function</span> <span class="token function">getHubFromCarrier</span><span class="token punctuation">(</span><span class="token parameter">carrier</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 已经有了则返回，没有则new Hub</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>carrier <span class="token operator">&amp;&amp;</span> carrier<span class="token punctuation">.</span>__SENTRY__ <span class="token operator">&amp;&amp;</span> carrier<span class="token punctuation">.</span>__SENTRY__<span class="token punctuation">.</span>hub<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> carrier<span class="token punctuation">.</span>__SENTRY__<span class="token punctuation">.</span>hub<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	carrier<span class="token punctuation">.</span>__SENTRY__ <span class="token operator">=</span> carrier<span class="token punctuation">.</span>__SENTRY__ <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	carrier<span class="token punctuation">.</span>__SENTRY__<span class="token punctuation">.</span>hub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> carrier<span class="token punctuation">.</span>__SENTRY__<span class="token punctuation">.</span>hub<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-3-bindclient-绑定客户端在当前控制中心上"><a href="#_7-3-bindclient-绑定客户端在当前控制中心上" class="header-anchor">#</a> 7.3 bindClient 绑定客户端在当前控制中心上</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Hub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bindClient</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 获取最后一个</span>
	<span class="token keyword">var</span> top <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStackTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 把 new BrowerClient() 实例 绑定到top上</span>
	top<span class="token punctuation">.</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Hub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getStackTop</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 获取最后一个</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_stack<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_7-4-小结2-经过一系列的继承和初始化"><a href="#_7-4-小结2-经过一系列的继承和初始化" class="header-anchor">#</a> 7.4 小结2. 经过一系列的继承和初始化</h3> <p>再回过头来看 <code>initAndBind</code>函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initAndBind</span><span class="token punctuation">(</span><span class="token parameter">clientClass<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>debug <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">clientClass</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token string">'client, options'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> currentHub <span class="token operator">=</span> <span class="token function">getCurrentHub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	currentHub<span class="token punctuation">.</span><span class="token function">bindClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'currentHub'</span><span class="token punctuation">,</span> currentHub<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 源代码</span>
	<span class="token comment">// getCurrentHub().bindClient(new clientClass(options));</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最终会得到这样的<code>Hub</code>实例对象。笔者画了一张图表示，便于查看理解。</p> <p><img src="/assets/img/Hub-instance-new.34d42e08.png" alt="Hub 实例关系图"></p> <p>初始化完成后，再来看具体例子。
具体 <code>captureMessage</code> 函数的实现。</p> <div class="language-js extra-class"><pre class="language-js"><code>Sentry<span class="token punctuation">.</span><span class="token function">captureMessage</span><span class="token punctuation">(</span><span class="token string">'Hello, 若川!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-capturemessage-函数"><a href="#_8-capturemessage-函数" class="header-anchor">#</a> 8. captureMessage 函数</h2> <p>通过之前的阅读代码，知道会最终会调用<code>Fetch</code>接口，所以直接断点调试即可，得出如下调用栈。
接下来描述调用栈的主要流程。</p> <p><img src="/assets/img/captureMessageCallStack.e64fe48b.png" alt="captureMessage 断点调试图"></p> <blockquote><p>调用栈主要流程：</p></blockquote> <p>captureMessage</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">captureMessage</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> level</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> syntheticException<span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span>exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		syntheticException <span class="token operator">=</span> exception<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 调用 callOnHub 方法</span>
	<span class="token keyword">return</span> <span class="token function">callOnHub</span><span class="token punctuation">(</span><span class="token string">'captureMessage'</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> level<span class="token punctuation">,</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">originalException</span><span class="token operator">:</span> message<span class="token punctuation">,</span>
		<span class="token literal-property property">syntheticException</span><span class="token operator">:</span> syntheticException<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>=&gt; callOnHub</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * This calls a function on the current hub.
 * @param method function to call on hub.
 * @param args to pass to function.
 */</span>
<span class="token keyword">function</span> <span class="token function">callOnHub</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 这里method 传进来的是 'captureMessage'</span>
	<span class="token comment">// 把method除外的其他参数放到args数组中</span>
	<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> _i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> _i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> _i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		args<span class="token punctuation">[</span>_i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>_i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 获取当前控制中心 hub</span>
	<span class="token keyword">var</span> hub <span class="token operator">=</span> <span class="token function">getCurrentHub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 有这个方法 把args 数组展开，传递给 hub[method] 执行</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>hub <span class="token operator">&amp;&amp;</span> hub<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// tslint:disable-next-line:no-unsafe-any</span>
		<span class="token keyword">return</span> hub<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>hub<span class="token punctuation">,</span> <span class="token function">__spread</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No hub defined or &quot;</span> <span class="token operator">+</span> method <span class="token operator">+</span> <span class="token string">&quot; was not found on the hub, please open a bug report.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>=&gt;  Hub.prototype.captureMessage</p> <p>接着看<code>Hub.prototype</code> 上定义的 <code>captureMessage</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Hub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">captureMessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> level<span class="token punctuation">,</span> hint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> eventId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_lastEventId <span class="token operator">=</span> <span class="token function">uuid4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> finalHint <span class="token operator">=</span> hint<span class="token punctuation">;</span>
	<span class="token comment">// 代码有删减</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_invokeClient</span><span class="token punctuation">(</span><span class="token string">'captureMessage'</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> level<span class="token punctuation">,</span> <span class="token function">__assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> finalHint<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">event_id</span><span class="token operator">:</span> eventId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> eventId<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt; Hub.prototype._invokeClient</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Internal helper function to call a method on the top client if it exists.
 *
 * @param method The method to call on the client.
 * @param args Arguments to pass to the client function.
 */</span>
<span class="token class-name">Hub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_invokeClient</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 同样：这里method 传进来的是 'captureMessage'</span>
	<span class="token comment">// 把method除外的其他参数放到args数组中</span>
	<span class="token keyword">var</span> _a<span class="token punctuation">;</span>
	<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> _i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> _i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> _i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		args<span class="token punctuation">[</span>_i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>_i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> top <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStackTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 获取控制中心的 hub，调用客户端也就是new BrowerClient () 实例中继承自 BaseClient 的 captureMessage 方法</span>
	<span class="token comment">// 有这个方法 把args 数组展开，传递给 hub[method] 执行</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>client <span class="token operator">&amp;&amp;</span> top<span class="token punctuation">.</span>client<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token punctuation">(</span>_a <span class="token operator">=</span> top<span class="token punctuation">.</span>client<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_a<span class="token punctuation">,</span> <span class="token function">__spread</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token punctuation">[</span>top<span class="token punctuation">.</span>scope<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt; BaseClient.prototype.captureMessage</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">BaseClient</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">captureMessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> level<span class="token punctuation">,</span> hint<span class="token punctuation">,</span> scope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> eventId <span class="token operator">=</span> hint <span class="token operator">&amp;&amp;</span> hint<span class="token punctuation">.</span>event_id<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_processing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> promisedEvent <span class="token operator">=</span> <span class="token function">isPrimitive</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
		<span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eventFromMessage</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">,</span> level<span class="token punctuation">,</span> hint<span class="token punctuation">)</span>
		<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eventFromException</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> hint<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 代码有删减</span>
	promisedEvent
		<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> _this<span class="token punctuation">.</span><span class="token function">_processEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> hint<span class="token punctuation">,</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// 代码有删减</span>
	<span class="token keyword">return</span> eventId<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>最后会调用 <code>_processEvent</code> 也就是</p> <p>=&gt; BaseClient.prototype._processEvent</p> <p>这个函数最终会调用</p> <div class="language-js extra-class"><pre class="language-js"><code>_this<span class="token punctuation">.</span><span class="token function">_getBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendEvent</span><span class="token punctuation">(</span>finalEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也就是</p> <p>=&gt;  BaseBackend.prototype.sendEvent</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">BaseBackend</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sendEvent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_transport<span class="token punctuation">.</span><span class="token function">sendEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error while sending event: &quot;</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt; FetchTransport.prototype.sendEvent 最终发送了请求</p> <h3 id="_8-1-fetchtransport-prototype-sendevent"><a href="#_8-1-fetchtransport-prototype-sendevent" class="header-anchor">#</a> 8.1 FetchTransport.prototype.sendEvent</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">FetchTransport</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sendEvent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
		<span class="token comment">// Despite all stars in the sky saying that Edge supports old draft syntax, aka 'never', 'always', 'origin' and 'default</span>
		<span class="token comment">// https://caniuse.com/#feat=referrer-policy</span>
		<span class="token comment">// It doesn't. And it throw exception instead of ignoring this parameter...</span>
		<span class="token comment">// REF: https://github.com/getsentry/raven-js/issues/1233</span>
		<span class="token literal-property property">referrerPolicy</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">supportsReferrerPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'origin'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// global$2.fetch(this.url, defaultOptions) 使用fetch发送请求</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>global$2<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> defaultOptions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token literal-property property">status</span><span class="token operator">:</span> exports<span class="token punctuation">.</span>Status<span class="token punctuation">.</span><span class="token function">fromHttpCode</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>看完 <code>Ajax 上报</code> 主线，再看本文的另外一条主线 <code>window.onerror</code> 捕获。</p> <h2 id="_9-window-onerror-和-window-onunhandledrejection-捕获-错误"><a href="#_9-window-onerror-和-window-onunhandledrejection-捕获-错误" class="header-anchor">#</a> 9. window.onerror 和 window.onunhandledrejection 捕获 错误</h2> <p>例子：调用一个未申明的变量。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>Promise</code> 不捕获错误</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_9-1-captureevent"><a href="#_9-1-captureevent" class="header-anchor">#</a> 9.1 captureEvent</h3> <blockquote><p>调用栈主要流程：</p></blockquote> <blockquote><p>window.onerror</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">GlobalHandlers</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_installGlobalOnErrorHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_onErrorHandlerInstalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// tslint:disable-line:no-this-assignment</span>
	<span class="token comment">// 浏览器中这里的 this._global.  就是window</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_oldOnErrorHandler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_global<span class="token punctuation">.</span>onerror<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_global<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> line<span class="token punctuation">,</span> column<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> currentHub <span class="token operator">=</span> <span class="token function">getCurrentHub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 代码有删减</span>
		currentHub<span class="token punctuation">.</span><span class="token function">captureEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">originalException</span><span class="token operator">:</span> error<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_oldOnErrorHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">_oldOnErrorHandler</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_onErrorHandlerInstalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>window.onunhandledrejection</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">GlobalHandlers</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_installGlobalOnUnhandledRejectionHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_onUnhandledRejectionHandlerInstalled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// tslint:disable-line:no-this-assignment</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_oldOnUnhandledRejectionHandler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_global<span class="token punctuation">.</span>onunhandledrejection<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_global<span class="token punctuation">.</span><span class="token function-variable function">onunhandledrejection</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 代码有删减</span>
		<span class="token keyword">var</span> currentHub <span class="token operator">=</span> <span class="token function">getCurrentHub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		currentHub<span class="token punctuation">.</span><span class="token function">captureEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">originalException</span><span class="token operator">:</span> error<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_oldOnUnhandledRejectionHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token function">_oldOnUnhandledRejectionHandler</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_onUnhandledRejectionHandlerInstalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>共同点：都会调用<code>currentHub.captureEvent</code></p> <div class="language-js extra-class"><pre class="language-js"><code>currentHub<span class="token punctuation">.</span><span class="token function">captureEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">originalException</span><span class="token operator">:</span> error<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>=&gt; Hub.prototype.captureEvent</p> <p>最终又是调用 <code>_invokeClient</code> ，调用流程跟 <code>captureMessage</code> 类似，这里就不再赘述。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_invokeClient</span><span class="token punctuation">(</span><span class="token string">'captureEvent'</span><span class="token punctuation">)</span>
</code></pre></div><p>=&gt; Hub.prototype._invokeClient</p> <p>=&gt; BaseClient.prototype.captureEvent</p> <p>=&gt; BaseClient.prototype._processEvent</p> <p>=&gt;  BaseBackend.prototype.sendEvent</p> <p>=&gt; FetchTransport.prototype.sendEvent</p> <p>最终同样是调用了这个函数发送了请求。</p> <p>可谓是殊途同归，行文至此就基本已经结束，最后总结一下。</p> <h2 id="_10-总结"><a href="#_10-总结" class="header-anchor">#</a> 10. 总结</h2> <p><code>Sentry-JavaScript</code>源码高效利用了<code>JS</code>的原型链机制。可谓是惊艳，值得学习。</p> <p>本文通过梳理前端错误监控知识、介绍<code>sentry</code>错误监控原理、<code>sentry</code>初始化、<code>Ajax</code>上报、<code>window.onerror、window.onunhandledrejection</code>几个方面来学习<code>sentry</code>的源码。还有很多细节和构造函数没有分析。</p> <p>总共的构造函数（类）有25个，提到的主要有9个，分别是：<code>Hub、BaseClient、BaseBackend、BaseTransport、FetchTransport、XHRTransport、BrowserBackend、BrowserClient、GlobalHandlers</code>。</p> <p>其他没有提到的分别是 <code>SentryError、Logger、Memo、SyncPromise、PromiseBuffer、Span、Scope、Dsn、API、NoopTransport、FunctionToString、InboundFilters、TryCatch、Breadcrumbs、LinkedErrors、UserAgent</code>。</p> <p>这些构造函数（类）中还有很多值得学习，比如同步的<code>Promise</code>（SyncPromise）。
有兴趣的读者，可以看这一块官方仓库中采用<code>typescript</code>写的源码<a href="https://github.com/getsentry/sentry-javascript/blob/master/packages/utils/src/syncpromise.ts" target="_blank" rel="noopener noreferrer">SyncPromise<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，也可以看打包后出来未压缩的代码。</p> <p>读源码比较耗费时间，写文章记录下来更加费时间（比如写这篇文章跨度十几天...），但收获一般都比较大。</p> <p>如果读者发现有不妥或可改善之处，再或者哪里没写明白的地方，欢迎评论指出。另外觉得写得不错，对您有些许帮助，可以点赞、评论、转发分享，也是对笔者的一种支持。万分感谢。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">11/30/2021, 6:31:05 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b6963aae.js" defer></script><script src="/assets/js/52.44f85c15.js" defer></script><script src="/assets/js/2.6f0b2cdc.js" defer></script><script src="/assets/js/7.e12f106b.js" defer></script>
  </body>
</html>
